[주소 결정 프로토콜]

-개요
 DNS는 FQDN을 IP주소로 변환하기 위해 사용한다. 또한 이더넷과 같은 
브로드캐스팅 전송이 가능한 네트워크에서는 실제 데이터 전송을 위해서는
반드시 수신시스템에게 데이터를 전송하기 전에 반드시 MAC 주소를 찾아야 한다.
이때 ARP 프로토콜은 해당 IP 주소를 이용하여 MAC 주소를 찾아주는 대표적인 프로토콜 이다.


- 종류

ARP : 논리적 주소를 물리적 주소로 변환 (IP 주소 > MAC 주소)

RARP : 물리적 주소를 논리적 주소로 변환 (MAC 주소 > IP 주소)


- 주소 변환 방법

Static Mapping (정적 변환)
Dynamic Mapping (동적 변환)
=ARP
=RARP


[주소 변환 프로토콜(ARP)]

- 목적
ARP 프로토콜은 송신시스템이 수신시스템에게 데이터를 전송하기 위해서는 
수신시스템의 MAC 주소를 알아야만 전송할 수 있으며 이떄 논리적 주소인 IP를
물리적 주소인 MAC으로 변환할 때 사용하는 프로토콜이다.

-변환 단계

1단계 : Broadcast frame으로 MAC 주소 찾기
2단계 : Unicast frame으로 IP에 해당하는 MAC 주소 전송



[ARP 패킷 구조]

-개요
다음은 ARP 프래임 구조와 캡슐화된 패킷의 모습이다.

ARP 패킷(32비트)
-하드웨어 종류 / 프로토콜 종류
-하드웨어 길이 / 프코토콜 길이 / 작동 모드. Request : 1 Reply : 2
- 송신 물리적 주소
- 송신 논리적 주소
- 수신 물리적 주소
- 수신 논리적 주소


[ARP 하드웨어 종류]

- 개요

ARP 패킷의 구조중 하드웨어 종류의 필드값에 따라 데이타링크층에서
생성할 수 있는 프래임을 나타낼 수 있다.

-종류

하드웨어 종류 값 / 네트워크 설명

1 / 이더넷(10Mbps)

2 / 실험적 이더넷(3Mbps)

3 / 아마추어 무선 AX.25

4 / ProNET 토큰링

5 / Chaos NET

6 / IEEE 802.

7 / ARCNET

8 / Hyperchannel

9 / Lanstar

10 / Autonet

11 / LocalTalk

12 / LocalNet

13 / Ultra Link

14 / SMDS

15 / Frame Relay

16 / AMT

17 / HDLC

18 / 공섬유 채널

19 / ATM

20 / 직열회선



[ARP 패킷의 작동 값]


- 개요

ARP 패킷의 구조중 Operation (작동) 필드의 역할에 따라 ARP 요청인지
응답인지를 확인할 수 있다.

- 작동 값

작동 필드 값 / 작동 유형

1 / ARP 요청

2 / ARP 응답

3 / RARP 요청

4 / RARP 응답



[ARP (주소결정 프로토콜)]

-개념

ARP 프로토콜은 논리적 IP 주소를 물리적 하드웨어 주소인 MAC 주소를 알기 위해
사용하는 프로토콜이다.

-적용 예제

=상황
만일 송신시스템 IP주소가 192.168.1.10/24 이고 수신시스템 IP 주소가 192.168.1.11/24라고
가정할 때, 다음과 같은 방법으로 수신시스템의 MAC 주소를 찾는다.

- 절차

단계 1) 캐시 테이블내에 해당 IP 주소에 대한 MAC 주소가 존재한다면 ARP Request를 보내지 않는다.

단계 2) 만일 캐시 테이블에 해당 IP주소에 대한 MAC 주소가 존재하지 않는다면 ARP Request라는
	브로드 케스팅 프래임을 해당세그먼트내 존재하는 모든 시스템에게 전송한다.

단계 3) 같은 세그먼트에 존재하는 모든 시스템은 ARP Request라는 브로드캐스팅 프래임을 받고
	도착지 IP주소와 자체 IP주소를 비교한 후 일치하지 않으면 해당 프래임을 무시한다.


[ARP Request 프래임 구조]

fcs , 수신 IP , 수신 HA , 송신 IP , 송신 MAC , 작동 0X1 , Plen , Hlen , 프로토콜 종류 0x800
... , 출발지 IP(192.168.0.10) ,  도착지 IP (192.168.0.11) , 종류 0x806 , 출발지 MAC (00-11-12-13-14-15) 도착지 MAC ALL''L , S.D , P


단계 4) 시스템 B,C,D 모두 ARP Request에 대한 반응으로 프래임을 분리한 후 캐시는 다음과 같이 동작 한다.


하드웨어 종류 지원 여부(아닐시 삭제) > 프로토콜 종류 지원(아닐시 삭제) > 
Merge-flag를 false로 설정 > ARP 캐시네 프로토콜 종류, 송신시스템 IP 주소 존재 유무 확인 
예 : ARP 캐시내 송신 시스템 HA갱신 Merge flag를 true로 설정 > 목표 IP 주소인가
아니오 :  목표 IP 주소인가 

목표 IP 주소인가 
예 : Mereg-flag가 false 인가  > 프로토콜 종류 , 송신자 프로토콜 주소 , 송신자 HA를 ARP 캐시에 추가
아니오 : 넘어감

> 작동 필드에 ARP 요청으로 설정되었는지 확인(아닐시 삭제)

- ARP 패킷의 출발지 주소와 대상 주소 필드를 바꾼다.

- 작동 필드에 ARP 응답으로 설정한다.

- ARP 패킷을 송신자에게 보낸다.

단계 5) 수신시스템 D는 ARP Reply 패킷을 송신 시스템 A에게 
	유니캐스트 프래임을 만들어 송신한다.


[ARP 캐시 테이블의 시간 종료]

- 개념
ARP 캐시내 저장된 정보는 일정시간이 지날때까지 사용되지 않으면 캐시내 저장 시간이 만료되며 깨끗이 청소 되어진다.
이때 캐시 테이블내 타임스탬프에 의해 이루어진다.

- ARP 캐시 정보 생명주기

= Normal cache Lifetime
최초 2분 저장
2분이내 사용시 10분씩 연장됨

= Incremental cache Lifetime
최초 2분 저장
2분이내 사용시 잔여분 + 10분씩 연장

주의 > 통상 TCP/|P 관련 캐시 시간 종료는 15분을 기본값으로 한다.


[중복 IP주소와 ARP 관계성]

- 개요
일반적으로 네트워크상에서 IP주소는 유일해야 한다. 만일 이 유일성을 보장 받을 수 없다면
즉, 사용자들의 실수에 의해 중복된 IP주소가 발생한다면 대단한 혼란과 혼동이 발생할 수 있다.
이로 인해 네트워크용 응용프로그램들 또한 간혈적으로 또는 가끔씩 작업을 멈추게 된다.


- IP 중복이 발생할 수 있는 상황
TCP/IP 클라이언트에서의 중복 IP주소
TCP/IP 서버에서의 중복 IP주소


[TCP/IP 클라이언트에서의 IP중복]

- 상황
다음 아래와 같이 시스템 A와 시스템 B라는 두대의 클라이언트 IP주소가 192.168.1.10/24로
중복되어 중앙 TCP/IP 서버에 연결을 시도한다고 가정한 후 어떠한 일이 발생하는지를
확인하자. 또한 각 클라이언트 MAC 주소는 1E-00-00-00-00-00 과 1D-00-00-00-00 이며
TCP/IP 서버 IP 주소는 00-01-02-03-04-05 이다.

필요 시스템

클라이언트 A (192.168.1.10/24 | 1E-00-00-00-00-00)
클라이언트 B (192.168.1.10/24 | 1D-00-00-00-00-00)
TCP/IP 서버 (192.168.1.254/24 | 00-01-02-03-04-05)


 - 적용단계

단계 1) 시스템 A가 TCP/IP 서버와 FTP 세션을 시작한다.
	시작되었으므로, 시스템 A는 FTP 서버 MAC 주소를 알기 위해
	브로드캐스팅을 통해 ARP Request를 보낸다.

단계 2) ftp 서버는 ARP Request을 받을 때 자체의 ARP 캐시테이블에
	ARP Request로부터 받은 송신시스템 A의 MAC(1E-00-00-00-00-00)을
	추가하고 ARP Reply로 응답한다.

단계 3) 송신시스템은 ARP 응답을 받을 때, 자체의 지역 ARP 캐시 테이블에
	FTP 서버에 대한 MAC 주소를 추가한다.

- FTP 캐시테이블 (192.168.1.10 / 1E-00-00-00-00-00)
- 시스템 A (192.168.1.254 / 00-01-02-03-04-05)


단계 4) 이제 시스템 B가 같은 FTP 서버에게 세션을 연결하려고 한다.

단계 5) 시스템 B 또한 FTP 서버에 세션을 연결하기전에 MAC 주소를
	알아야만 하므로 ARP Request에 대한 수신을하기전 자체 ARP
	캐시테이블에 시스템 B에 대한 MAC 주소를 추가하려고 하지만
	이미 192.168.1.10에 대한 MAC 주소가 1E-00-00-00-00-00 있다는
	것을 발견한다.

단계 6) 이때 주소 결정 프로토콜에 관란 RFC826에 따라 FTP 서버는
	기존 항목을 새로운 시스템 B에 대한 MAC 주소로 바꾸어
	버린다. 이때 Unix / Linux 인 경우는 중복 IP 문제에 대한 경고 없이
	대체 작업을 조용히 수행한다.

- FTP 캐시테이블 (192.168.1.10 / 1D-00-00-00-00-00)
- 시스템 A (192.168.1.254 / 00-01-02-03-04-05)


단계 7) FTP 서버가 이제 시스템 A에게 데이터를 송신할 경우 모든 데이터는 시스템 B에게 송신 되어진다.

단계 8) 시스템 A는 응답을 기다리다가 결국 정지하게 되고 시스템
	복구를 위해 다시 부트할 경우가 발생한다. 종종 잘 작동하던 응용프로그램이 멈추어서 사용자와
	관리자를 놀라게 할 때도 있다.

[TCP/IP 서버에서의 TCP/IP 서버에서의 IP중복]

-상황 
이제는 FTP 서비스를 제공하는 서버의 IP주소가 중복되었다고 가정한 후
어떤일이 발생하는지를 알아보자. 
시스템 A IP 주소는 192.168.1.10.24 이며
MAC는 1E-00-00-00-00-00 이고 
FTP 서버 IP 주소는 192.168.1.254/24 이며
MAC는 00-01-02-03-04-05 이다.
또한 FTP 서버 중복시스템(B) IP 주소는 192.168.1.254/24 이며
MAC는 EE-01-02-03-04-05 이다.


단계1 ) 시스템 A는 FTP 서버에 접속하기 위해 ARP Request라는 브로드캐스팅을 하여
	FTP 서버의 MAC 주소를 알려고 한다.

단계 2) 그런데 FTP 서버 IP 주소가 같은 대상 서버가 2대이므로 모두 다 ARP Request에
	대한 요청을 받으면 자체의 지역 캐시테이블에 ARP Request를 보낸 시스템 A의
	MAC 주소를 추가하고 ARP Reply 패킷을 보낸다.

단계 3) 이떄 ARP Reply 응답 패킷이 2개가 되며 시스템 A는 첫 번째 ARP Reply 응답을
	받아 들이고 두 번째 응답은 무시한다.


-FTP 서버1 (192.168.1.10 / 1E-00-00-00-00-00)

-FTP 서버2_중복IP주소 (192.168.1.10 / 1E-00-00-00-00-00)

-시스템 A (192.168.1.254 / 1D-01-02-03-04-05)

단계 4) 시스템 A는 원래 접속하기를 원하는 FTP 서버가 아닌 중복된 IP 주소를 갖는 FTP 서버(2)와
	대화를 하게 된다. 만일 FTP 서버(2)가 예상한 서비스를 가지고 있지 않다면 연결을 실패하고
	사용자는 서버에서 지원되지 않은 서비스에 관한 오류 메시지를 받게 될 것이다.


[요점 정리]

- ARP란 IP주소를 MAC 주소로 해석하기 위한 프로토콜이며
  실제 송신시스템이 수신시스템에게 데이터 전송하기 전에 반드시
  반드시 수신시스템의 MAC 주소를 알아야만 전송할 수 있으므로 대단히
  중요한 프로토콜이다.

- ARP Request는 브로드캐스팅 프래임 구조를 가지고 있으며
  ARP Reply는 유니캐스팅 구조를 가지고 있다.

- ARP Cache 사용목적은 송신시스템이 수신시스템에게
  데이터를 보내기전에 반드시 MAC 주소를 알아야만 하나
  만일 송신시스템의 캐시내 해당 수신시스템의 IP 주소와
  MAC 주소를 보유한다면 브로드캐스팅을 발생하지 않고
  곧바로 데이터 전송이 가능하도록 하기 위해 만들어졌다.




































